syntax on                                 " enable syntax highlighting
filetype plugin indent on                 " enable filetype and indentation plugins
set nocompatible                          " we certainly don't care anymore about being compatible
set encoding=utf-8                        " utf-8 all the things
set autoindent                            " keep indentation for new lines

set shiftwidth=4                          " vim shifts by 2 spaces
set softtabstop=4                         " as does tab
set tabstop=4                             " existing tabs count as 2 spaces
set expandtab                             " spaces are my preferred indentation method
set colorcolumn=80                        " display 80 chars text width limit

augroup Numbertoggle                      " toggle relative line numbers
  autocmd!
  if exists("##TerminalOpen") == "1"
    autocmd TerminalOpen * setlocal nonumber norelativenumber
  endif

  autocmd BufEnter,FocusGained,InsertLeave * call FocusLineNumbers()
  autocmd BufLeave,FocusLost,InsertEnter * call BlurLineNumbers()

  function BlurLineNumbers()
      if &buftype != "terminal"
          setlocal norelativenumber
      endif
  endfunction

  function FocusLineNumbers()
      if &buftype != "terminal"
          setlocal relativenumber
      endif
  endfunction
augroup END

set scrolloff=5                           " always show two more lines at the window border
set number                                " show absolute line number at cursor position
set showcmd                               " show contents of command buffer
set ruler                                 " show cursor position
set nomodeline                            " disable modelines (i use local-vimrc for that, it's safer)

set incsearch                             " search as you type
set hlsearch                              " highlight matches
set ignorecase                            " search case insensitive per default...
set smartcase                             " ...but only when there is no uppercase character

set noswapfile                            " disable .swp files
set hidden                                " keep hidden file buffers instead of unloading them

set ttyfast                               " improve drawing speed

set splitright                            " split to right pane
set splitbelow                            " split to bottom pane

" color customizations {{{
set background=dark                       " dark terminal background is default

au BufEnter,BufNew,Syntax * hi EOLWhitespace guifg=red guibg=red ctermfg=red ctermbg=red
au BufEnter,BufNew,Syntax * match EOLWhitespace /\s\+$/
" }}}

set nospell                               " disable spell checking (we're mostly in source code files)
augroup Git
  autocmd!
  autocmd FileType gitcommit set spell    " re-enable spell checking for commit messages
augroup END

set wildmenu                              " show auto-complete menu in command mode
set wildmode=longest:full,full            " make autocomplete more intelligent
set wildignore=*/node_modules/*,node_modules/*,*/.git/*,*/vendor/*,*/var/*,var/*

set showmatch                             " enable bracket highlights
set matchpairs=(:),{:},[:],<:>            " highlight all kinds of brackets

set foldenable                            " enable folding generally
set foldmethod=marker                     " auto-fold by markers
set foldlevel=0                           " auto-fold from first level on

if executable('ag')
  " Use Ag over Grep
  set grepprg=ag\ --vimgrep\ --ignore=var/\ --ignore=vendor/\ --ignore=var/
endif

augroup Vue
  autocmd!
  autocmd FileType vue syntax sync fromstart " fix vue files syntax hiccups
augroup END

augroup Terminal
  autocmd!
  if exists("##TerminalOpen") == "1"
    autocmd TerminalOpen * setlocal nonumber norelativenumber
  endif
augroup END

" abbreviations {{{
inoreabbrev ive i've
inoreabbrev im i'm
inoreabbrev youve you've
inoreabbrev youre you're
inoreabbrev hes he's
inoreabbrev shes she's
inoreabbrev weve we've
inoreabbrev were we're
inoreabbrev theyve they've
inoreabbrev theyre they're
inoreabbrev theres there's
inoreabbrev wheres where's
inoreabbrev whys why's
inoreabbrev hows how's
inoreabbrev whats what's
inoreabbrev whens when's
inoreabbrev thats that's
inoreabbrev isnt isn't
inoreabbrev arent aren't
inoreabbrev wasnt wasn't
inoreabbrev werent weren't
inoreabbrev hasnt hasn't
inoreabbrev havent haven't
inoreabbrev mustnt mustn't
inoreabbrev couldnt couldn't
inoreabbrev shouldnt shouldn't
inoreabbrev wouldnt wouldn't
inoreabbrev oclock o'clock
" }}}

function ToggleWhitespace()
    if &syntax == 'whitespace'
        execute 'set syntax=' . b:original_syntax
    else
        let b:original_syntax = &syntax
        set syntax=whitespace
    endif
endfunction

" netrw settings {{{
" no banner
let g:netrw_banner=0
" tree listing as default
let g:netrw_liststyle=3
" open files in previous window
let g:netrw_browse_split=4
" }}}

" custom keyboard mappings {{{
" leader for custom commands, used by plugins
:let mapleader = ","
" allow to use jk to exit insertmode
inoremap jk <esc>
" allow to use jk to exit terminal mode
tnoremap jk <C-W>N
" remap split navigation to shorter combo
nnoremap <C-h> <C-w>h
" remap split navigation to shorter combo
nnoremap <C-j> <C-w>j
" remap split navigation to shorter combo
nnoremap <C-k> <C-w>k
" remap split navigation to shorter combo
nnoremap <C-l> <C-w>l
" handy quickfix window commands
nnoremap q] :cnext<CR>
nnoremap q[ :cprevious<CR>
" disable obnoxious ex mode
nnoremap Q <nop>
" remap W to w
command! W w
" make Y behave as D, C, etc
cnoremap Y y$
" disable search highlighting
nnoremap <leader>ch :nohlsearch<CR>
" shortcut to edit vimrc
nnoremap <leader>ve :tabnew ~/.vimrc<CR>
" shortcut to reload vimrc
nnoremap <leader>vr :source ~/.vimrc<CR>
" open file navigator on the leftmost side
nnoremap <leader>rr :20Vex<CR>
" toggle whitespace display
nnoremap <leader><space> :call ToggleWhitespace()<CR>
" auto insert closing parenthesis and quotes
inoremap ( ()<Left>
inoremap { {}<Left>
inoremap [ []<Left>
inoremap < <><Left>
inoremap " ""<Left>
inoremap ' ''<Left>
inoremap ` ``<Left>
" grep should not jump to the first result and open quickfix list
command! -nargs=+ -complete=file Grep grep! <args> | execute ":clist"
" lgrep should not jump to the first result and open location list
command! -nargs=+ -complete=file Lgrep lgrep! <args> | execute ":llist"
" copy the current file path to the clipboard
nnoremap <leader>cp :let @*=expand('%')<CR>
" search for all TODOs in the current folder
nnoremap <leader>td :Grep TODO<CR>
" }}}

" vim airline plugin {{{
set runtimepath^=~/.vim/bundle/vim-airline/
set noshowmode
let g:airline#extensions#tagbar#enabled = 1
let g:airline#extensions#tabline#enabled = 1
let g:airline#extensions#gutentags#enabled = 1
let g:airline#extensions#tabline#buffer_nr_show = 1
let g:airline#extensions#branch#displayed_head_limit=20
" }}}

" vim airline theme plugin {{{
set runtimepath^=~/.vim/bundle/vim-airline-themes/
let g:airline_theme='base16color'
let g:airline_powerline_fonts = 1
let g:airline_skip_empty_sections = 1
" }}}

" vim gitgutter plugin {{{
set runtimepath^=~/.vim/bundle/vim-gitgutter/
let g:gitgutter_map_keys = 0
nnoremap <leader>gp :GitGutterPreviewHunk<CR>
nnoremap <leader>gu :GitGutterUndoHunk<CR>
nnoremap ]h :GitGutterNextHunk<CR>
nnoremap [h :GitGutterPrevHunk<CR>
" }}}

" vim localvimrc plugin {{{
set runtimepath^=~/.vim/bundle/vim-localvimrc/
let g:localvimrc_whitelist=['/Users/bsa/src/.*', '/home/bsa/src/.*']
let g:localvimrc_sandbox=0
" }}}

" vim gutentags plugin {{{
set runtimepath^=~/.vim/bundle/vim-gutentags/
set statusline+=%{gutentags#statusline()}
let g:gutentags_cache_dir='~/.ctagscache/'
" }}}

" tagbar plugin {{{
set runtimepath^=~/.vim/bundle/tagbar/
nnoremap <Leader>tt :Tagbar<CR>
let g:tagbar_autofocus = 1
" }}}

" pug syntax plugin {{{
set runtimepath^=~/.vim/bundle/vim-pug/
" }}}

" vim fugitive plugin {{{
set runtimepath^=~/.vim/bundle/vim-fugitive/
" }}}

" vim coc plugin {{{
set runtimepath^=~/.vim/bundle/coc.nvim/
nmap gd <Plug>(coc-definition)
nmap gy <Plug>(coc-type-definition)
nmap gi <Plug>(coc-implementation)
nmap gr <Plug>(coc-references)
imap <expr> <c-space> coc#refresh()
nmap <leader>cd :call <SID>show_documentation()<CR>

function! s:show_documentation()
  if (index(['vim','help'], &filetype) >= 0)
    execute 'h '.expand('<cword>')
  else
    call CocAction('doHover')
  endif
endfunction
" }}}

" FZF plugin {{{
set runtimepath^=/usr/local/opt/fzf/
" }}}

" fzf.vim plugin {{{
set runtimepath^=~/.vim/bundle/fzf.vim/
let $FZF_DEFAULT_OPTS = '--border --bind=ctrl-n:page-down,ctrl-p:page-up'
nnoremap <Leader>zf :Files<CR>
nnoremap <Leader>zt :Tags<CR>
nnoremap <Leader>zb :Buffers<CR>
nnoremap <Leader>zc :BCommits<CR>
nnoremap <Leader>zh :History<CR>
nnoremap <Leader>zs :GFiles?<CR>

function! OpenFloatingWin()
  let height = &lines - 3
  let width = float2nr(&columns - (&columns * 2 / 10))
  let col = float2nr((&columns - width) / 2)

  "Set the position, size, etc. of the floating window.
  "The size configuration here may not be so flexible, and there's room for further improvement.
  let opts = {
        \ 'relative': 'editor',
        \ 'row': height * 0.3,
        \ 'col': col + 15,
        \ 'width': width * 2 / 3,
        \ 'height': height / 2
        \ }

  let buf = nvim_create_buf(v:false, v:true)
  let win = nvim_open_win(buf, v:true, opts)

  "Set Floating Window Highlighting
  call setwinvar(win, '&winhl', 'Normal:Pmenu')

  setlocal
        \ buftype=nofile
        \ nobuflisted
        \ bufhidden=hide
        \ nonumber
        \ norelativenumber
        \ signcolumn=no
endfunction
let g:fzf_layout = { 'window': 'call OpenFloatingWin()' }
" }}}

" {{{ editorconfig files
set runtimepath^=~/.vim/bundle/editorconfig-vim/
let g:EditorConfig_exclude_patterns = ['fugitive://.*']
" }}}

" {{{ vim-test plugin
set runtimepath^=~/.vim/bundle/vim-test
nmap <Leader>tn :TestNearest<CR>
nmap <Leader>tf :TestFile<CR>
nmap <Leader>ts :TestSuite<CR>
nmap <Leader>tl :TestLast<CR>
nmap <Leader>tg :TestVisit<CR>
" }}}

" {{{ ale
set runtimepath^=~/.vim/bundle/ale
let g:ale_echo_msg_format = '[%linter%] %s [%severity%]'
" }}}

" {{{ vim-surround
set runtimepath^=~/.vim/bundle/vim-surround
" }}}
